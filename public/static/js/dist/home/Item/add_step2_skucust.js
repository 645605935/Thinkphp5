$(function(){HYD.ItemAdd.norms=[],HYD.ItemAdd.props={},HYD.ItemAdd.sku={},HYD.ItemAdd.skuCache={},HYD.ItemAdd.skustyle={skustyle:$(".j-skustyle:checked").val()},HYD.ItemAdd.skuimg={};var a=function(){var a=$("#tpl_add_step2_normslist").html(),b=_.template(a,{dataset:HYD.ItemAdd.norms,props:HYD.ItemAdd.props,skustyle:HYD.ItemAdd.skustyle});$(".normsPanel .normslist").remove(),$(b).insertBefore("#j-addNorms"),$("#j-normsVal").val(JSON.stringify(HYD.ItemAdd.norms)),HYD.ItemAdd.norms.length<5?$("#j-addNorms").show():$("#j-addNorms").hide()},b=function(){var a=$("#tpl_add_step2_sku").html(),b=_.template(a,{sku:HYD.ItemAdd.sku,norms:HYD.ItemAdd.norms,props:HYD.ItemAdd.props,skustyle:HYD.ItemAdd.skustyle});$("#j-skuPanel .wxtables").remove(),$("#j-skuPanel").append(b),$("#j-skuVal").val(JSON.stringify(HYD.ItemAdd.sku)),$(".J-options-slideToggle").on("click",function(){$(this).parent().children(".setfxs-box").toggle()})},c=function(a,b){if(HYD.ItemAdd.skuCache[a])HYD.ItemAdd.sku[a]=HYD.ItemAdd.skuCache[a];else{var c=a.split(";"),d=c.join("-");HYD.ItemAdd.skuCache[a]=HYD.ItemAdd.sku[a]={o_price:0,price:0,stock:0,code:"",salenum:0,props:c,rank_props:d,rank_price:[],sku_img:""}}},d=function(a,b,c){for(var d in HYD.ItemAdd.props)if(HYD.ItemAdd.props[d]==a){var e={key:d,val:a};return void(c&&c(e))}$.ajax({url:"/Item/ajax_props",type:"post",dataType:"json",data:{id:b,text:a},success:function(a){var b={key:a.key,val:a.text};c&&c(b)}})},e=function(){var a=[];switch(_.each(HYD.ItemAdd.norms,function(b){b.props.length&&a.push(b.props)}),HYD.ItemAdd.sku={},a.length){case 1:for(var b=0;b<a[0].length;b++){var d=[a[0][b]];c(d.join(";"))}break;case 2:for(var b=0;b<a[0].length;b++)for(var e=0;e<a[1].length;e++){var d=[a[0][b],a[1][e]];c(d.join(";"))}break;case 3:for(var b=0;b<a[0].length;b++)for(var e=0;e<a[1].length;e++)for(var f=0;f<a[2].length;f++){var d=[a[0][b],a[1][e],a[2][f]];c(d.join(";"))}break;case 4:for(var b=0;b<a[0].length;b++)for(var e=0;e<a[1].length;e++)for(var f=0;f<a[2].length;f++)for(var g=0;g<a[3].length;g++){var d=[a[0][b],a[1][e],a[2][f],a[3][g]];c(d.join(";"))}break;case 5:for(var b=0;b<a[0].length;b++)for(var e=0;e<a[1].length;e++)for(var f=0;f<a[2].length;f++)for(var g=0;g<a[3].length;g++)for(var h=0;h<a[4].length;h++){var d=[a[0][b],a[1][e],a[2][f],a[3][g],a[4][h]];c(d.join(";"))}}},f=function(){var a=$("#j-totalStock");if(HYD.ItemAdd.norms.length){a.attr("disabled",!0);var b=0;for(var c in HYD.ItemAdd.sku)b+=parseInt(HYD.ItemAdd.sku[c].stock);a.val(b)}else a.attr("disabled",!1)},g=$("#j-propsVal").val();g.length&&(HYD.ItemAdd.props=$.parseJSON(g));var h=$("#j-normsVal").val();h.length&&(HYD.ItemAdd.norms=$.parseJSON(h),a());var i=$("#j-skuVal").val();i.length&&(HYD.ItemAdd.skuCache=HYD.ItemAdd.sku=$.parseJSON(i),b()),f(),$(document).on("click","#j-addNorms",function(){var c={name:"规格名称",props:[]};return $.ajax({url:"/Item/ajax_norms",type:"post",dataType:"json",data:c,success:function(d){c.name=d.text,c.id=d.key,HYD.ItemAdd.norms.push(c),e(),a(),b(),f()}}),!1}),$(document).on("click",".j-delNorms",function(){var c=$(this).parents(".normslist").index();$(this).parents(".normslist").data("id");return HYD.ItemAdd.norms.splice(c,1),e(),a(),b(),f(),!1}),$(document).on("change",".j-normsName",function(){var c=$(this).val(),d=$(this).parents(".normslist").data("index");return $.ajax({url:"/Item/ajax_norms",type:"post",dataType:"json",data:{name:c},success:function(c){HYD.ItemAdd.norms[d].name=c.text,HYD.ItemAdd.norms[d].id=c.key,e(),a(),b()}}),!1}),$(document).on("click",".j-addNormsVal",function(){var c=$(this).parents(".normslist").data("index"),g=$(this).siblings(".j-addNormsVal-ipt").val(),h=$(this).parents(".normslist").data("id");if(g&&""!=g)return d(g,h,function(d){HYD.ItemAdd.props[d.key]=d.val,HYD.ItemAdd.norms[c].props.push(d.key),e(),a(),b(),f()}),!1}),$(document).on("click",".j-delNormsVal",function(){var c=parseInt($(this).parents(".normslist").data("index")),d=parseInt($(this).data("index"));return HYD.ItemAdd.norms[c].props.splice(d,1),e(),a(),b(),f(),!1}),$(document).on("change",".j-price-modify",function(){var c=$(this).val(),d=$(this).data("name"),g=$(this).parents("tr").data("key");return HYD.ItemAdd.skuCache[g][d]=HYD.ItemAdd.sku[g][d]=c,e(),a(),b(),f(),!1}),$(document).on("click",".j-title-selectimg",function(c){var d=$(this),g=d.parents("tr").data("key");HYD.popbox.ImgPicker(function(c){d.find("img").attr("src",c[0]),HYD.ItemAdd.skuCache[g].sku_img=HYD.ItemAdd.sku[g].sku_img=c[0],e(),a(),b(),f()})}),$(document).on("change",".j-skustyle",function(c){var d=$(this).val();HYD.ItemAdd.skustyle.skustyle=d,e(),a(),b(),f()})});