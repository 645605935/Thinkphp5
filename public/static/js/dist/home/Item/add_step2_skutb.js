$(function(){HYD.ItemAdd.norms=[],HYD.ItemAdd.props={},HYD.ItemAdd.propsAlias={},HYD.ItemAdd.propsIds=[],HYD.ItemAdd.sku={},HYD.ItemAdd.skuCache={},HYD.ItemAdd.skustyle={skustyle:$(".j-skustyle:checked").val()},HYD.ItemAdd.skuimg={};var a=function(a){var b=$("#tpl_add_step2_sku").html(),c=_.template(b,{sku:HYD.ItemAdd.sku,norms:HYD.ItemAdd.norms,props:HYD.ItemAdd.propsAlias,skustyle:HYD.ItemAdd.skustyle});$("#j-skuPanel .wxtables").remove(),$("#j-skuPanel").append(c),$("#j-skuVal").val(JSON.stringify(HYD.ItemAdd.sku)),$(".J-options-slideToggle").on("click",function(){$(this).parent().children(".setfxs-box").toggle()}),a&&a()},b=function(a){if(HYD.ItemAdd.skuCache[a])HYD.ItemAdd.sku[a]=HYD.ItemAdd.skuCache[a];else{var b=a.split(";"),c=b.join("-");HYD.ItemAdd.skuCache[a]=HYD.ItemAdd.sku[a]={skuId:0,o_price:0,price:0,stock:0,code:"",salenum:0,props:b,rank_props:c,rank_price:[],sku_img:""}}},c=function(a){var b=$("#j-totalStock");if(HYD.ItemAdd.norms.length){b.attr("disabled",!0);var c=0;for(var d in HYD.ItemAdd.sku)c+=parseInt(HYD.ItemAdd.sku[d].stock);b.val(c)}else b.attr("disabled",!1)},d=function(a){var b,c,e,f,g=[],h=[];if(f=a.split(";"),h.push(a),f.length===HYD.ItemAdd.propsIds.length)return h;for(b=0;b<HYD.ItemAdd.propsIds.length;b++){for(c=0;c<HYD.ItemAdd.propsIds[b].length&&f.length>0&&HYD.ItemAdd.propsIds[b][c]!=f[0];c++);if(!(c<HYD.ItemAdd.propsIds[b].length&&f.length>0)){for(e=0;e<HYD.ItemAdd.propsIds[b].length;e++)h=h.concat(d(g.concat(HYD.ItemAdd.propsIds[b][e],f).join(";")));break}g.push(f.shift())}return h},e=function(){HYD.ItemAdd.norms=[],HYD.ItemAdd.propsIds=[],HYD.ItemAdd.sku={},HYD.ItemAdd.propsCurNum=[],$(".j-selectProps").each(function(){var a=[],b=$(this).find(".j-normsid").val(),c=$(this).find(".j-normsid").data("name");$(this).find(".j-propid:checked").each(function(){a.push($(this).val())}),HYD.ItemAdd.propsCurNum.push(a),a.length&&(HYD.ItemAdd.propsIds.push(a),HYD.ItemAdd.norms.push({id:b,name:c,props:a}))}),$("#j-normsVal").val(JSON.stringify(HYD.ItemAdd.norms));var a=HYD.ItemAdd.propsIds.length,c=HYD.ItemAdd.propsCurNum.length;a==c&&_.each(HYD.ItemAdd.propsIds[0],function(c){var e=d(c.toString());_.each(e,function(c){var d=c.split(";");d.length==a&&b(c)})})},f=function(){$(".j-propid").each(function(){HYD.ItemAdd.propsAlias[$(this).siblings("span").data("v")]=$(this).siblings("span").find("input").val()?$(this).siblings("span").find("input").val():$(this).siblings("span").data("n")}),$("#j-propsAlias").val(JSON.stringify(HYD.ItemAdd.propsAlias)),a()},g=$("#j-propsVal").val();g.length&&(HYD.ItemAdd.props=$.parseJSON(g));var h=$("#j-normsVal").val();h.length&&(HYD.ItemAdd.norms=$.parseJSON(h));var i=$("#j-skuVal").val();i.length&&(HYD.ItemAdd.skuCache=HYD.ItemAdd.sku=$.parseJSON(i),a()),c(),f(),$(document).on("change",".j-price-modify",function(){var a=$(this).val(),b=$(this).data("name"),d=$(this).parents("tr").data("key");HYD.ItemAdd.skuCache[d][b]=HYD.ItemAdd.sku[d][b]=a,c(),$("#j-skuVal").val(JSON.stringify(HYD.ItemAdd.sku))}),$(document).on("click",".j-title-selectimg",function(a){var b=$(this),d=b.parents("tr").data("key");HYD.popbox.ImgPicker(function(a){b.find("img").attr("src",a[0]),HYD.ItemAdd.skuCache[d].sku_img=HYD.ItemAdd.sku[d].sku_img=a[0],c(),$("#j-skuVal").val(JSON.stringify(HYD.ItemAdd.sku))})});var j=function(a){var b=$('input[name="color_img"]').val();""==b?HYD.ItemAdd.skuimg={}:HYD.ItemAdd.skuimg=$.parseJSON(b);var c=[],d=a||$(".j-getsku:eq(0) .j-propid");d.filter(":checked").each(function(a,b){var d=$(this).val(),e=$(this).next(".J-alias").data("n");c.push({}),c[a].sku_id=d,c[a].sku_name=e,c[a].sku_img=HYD.ItemAdd.skuimg[d]?HYD.ItemAdd.skuimg[d]:"/Public/images/small_pic.png"});var e=$("#tpl_imgskulist").html(),f=_.template(e,{data:c});$("#j-skuImg").empty().append(f),$(document).on("click",".j-getskuimg",function(a){var b=$(this),c=b.data("skuid");HYD.popbox.ImgPicker(function(a){b.closest("td").prev("td").find("img").attr("src",a[0]),HYD.ItemAdd.skuimg[c]=a[0],$('input[name="color_img"]').val(JSON.stringify(HYD.ItemAdd.skuimg))})})};j(),$(document).on("change",".j-propid",function(){var b=$(this).parents(".j-selectProps"),d=b.find(".j-propid"),g=b.find(".j-normsid");$(this).attr("checked")?$(this).siblings("span").html('<input type="text" value="'+$(this).siblings("span").data("n")+'" class="J-aliasV w40" />'):$(this).attr("checked")||$(this).siblings("span").html($(this).siblings("span").data("n")),j(),g.attr("checked",d.length==d.filter(":checked").length),f(),e(),a(),c()}),$(document).on("change",".j-skustyle",function(b){var d=$(this).val();if(HYD.ItemAdd.skustyle.skustyle=d,1==d){var g=$("#tpl_imgsku").html();$("#j-skuImgWrapper").empty().html(g),j()}else $("#j-skuImgWrapper").empty();f(),e(),a(),c()}),$(document).on("change",".J-aliasV",function(){f();var a=$(this).val(),b=$(this).closest("span").data("v");$("#j-skuImg").find(":hidden[value="+b+"]").closest("td").prev("td").children("span").html(a)}),$(document).on("change",".j-normsid",function(){var a=$(this),b=a.parents(".j-selectProps").find(".j-propid");b.attr("checked",a.is(":checked")).change()})});